<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultado da Previsão - Nubank</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Importa a biblioteca Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Resultado da Previsão</h1>

        <!-- Onde o gráfico será renderizado -->
        <div class="chart-container" style="position: relative; height:40vh; width:80vw; max-width: 900px; margin: auto;">
            <canvas id="forecastChart"></canvas>
        </div>

        <h2>Valores Previstos</h2>
        
        {{ tabela_previsao|safe }}

        <div class="link-container">
            <a href="/" class="btn-voltar">Fazer outra previsão</a>
        </div>
    </div>

    <script>
        // Pega os dados enviados pelo Flask
        const chartData = {{ chart_data|tojson }};

        // Configuração do gráfico
        const ctx = document.getElementById('forecastChart').getContext('2d');
        const forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Receita Histórica (Observada)',
                        data: chartData.historical,
                        borderColor: '#8A05BE', // Roxo Nubank
                        backgroundColor: '#8A05BE',
                        fill: false,
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: 'Receita Prevista',
                        data: chartData.forecast,
                        borderColor: 'green',
                        backgroundColor: 'green',
                        borderDash: [5, 5], // Linha tracejada
                        fill: false,
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: 'Intervalo de Confiança (95%)',
                        data: chartData.ci_upper,
                        fill: '-1', // Preenche até o dataset anterior (IC Inferior)
                        backgroundColor: 'rgba(0, 128, 0, 0.1)',
                        borderColor: 'transparent',
                        pointRadius: 0, // Não mostra pontos
                        tension: 0.1,
                        borderWidth: 0
                    },
                    {
                        label: 'IC Inferior', // Dataset escondido, usado apenas para o preenchimento
                        data: chartData.ci_lower,
                        fill: false,
                        borderColor: 'transparent',
                        pointRadius: 0,
                        tension: 0.1,
                        borderWidth: 0,
                        showInLegend: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Previsão de Receita Trimestral da Nubank (NU)',
                        font: { size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    // Formata o valor para bilhões
                                    label += new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                        notation: 'compact',
                                        compactDisplay: 'short'
                                    }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Data'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Receita (USD)'
                        },
                        ticks: {
                            // Formata o eixo Y para mostrar valores em bilhões
                            callback: function(value, index, values) {
                                return new Intl.NumberFormat('en-US', {
                                    style: 'currency',
                                    currency: 'USD',
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                }).format(value);
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
